#!/usr/bin/env python3

import argparse
from datetime import datetime
import json
import sys

from intel_gpu_top_parser import parse


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description=(
            "Parse json file generated by `intel_gpu_tool -J` to"
            "check if GPU is being used"
        )
    )
    parser.add_argument(
        "logfiles",
        nargs=2,
        help=("Path to the 2 log files (with GPU decoding enabled/disabled) "
              "to parse."),
    )
    parser.add_argument(
        "--json", action="store_true", help="Output parsed info as JSON."
    )
    args = parser.parse_args()
    gpu_averages = []
    for logfile in args.logfiles:
        gpu_avg = parse(logfile)
        gpu_averages.append(gpu_avg)
        if not args.json:
            print("Processes in {} used {:.2f}% GPU.".format(logfile, gpu_avg))
    if args.json:
        output = {
            "date": datetime.utcnow().isoformat(),
            "gpu_before": gpu_averages[0],
            "gpu_after": gpu_averages[1],
        }
        print(json.dumps(output))
    else:
        if gpu_averages[0] > gpu_averages[1]:
            print()
            print("GPU usage is higher before compared to after.")
            print(("This seems correct, since more GPU is required for "
                   "hardware decoding."))
        else:
            print()
            sys.exit("Error: GPU usage is higher after compared to before.")
