#!/usr/bin/env python3

import argparse
from datetime import datetime
import json
import os.path
import sys

def parse(log_file):
    """
    Parse json file generated by `intel_gpu_tool -J` to check if GPU is being
    used.
    """
    if not os.path.isfile(log_file):
        raise FileNotFoundError("{} not found.".format(log_file))

    with open(log_file) as f:
        content = f.read().strip()

    # intel_gpu_top -J does not return valid JSON. The brackets are missing.
    if content[0] != "[":
        data = json.loads("[" + content + "]")
    else:
        data = json.loads(content)

    sumdata = {}
    for d in data:
        # Looking at the `engines` section only
        for k, v in d["engines"].items():
            # Focus on GPU usage for video encoding/decoding only
            if "Video/" in k and (v.get("busy") is not None):
                if sumdata.get(k):
                    sumdata[k] += v["busy"]
                else:
                    sumdata[k] = v["busy"]

    gpu_average = 0.0
    if data and sumdata:
        gpu_average = sum(sumdata.values()) / len(data)

    return gpu_average

if __name__ == "__main__":
    script = os.path.basename(__file__)
    parser = argparse.ArgumentParser(
        description=(
            "Parse json files generated by `intel_gpu_tool -J` before and "
            "after activating hardware acceleration to check if GPU is being "
            "used."
        ),
        epilog=(
            "Please ensure inputs are provided in the correct order: "
            "{} hw_acc_enabled.json hw_acc_disabled.json".format(script)
        ),
    )
    parser.add_argument(
        "logfiles",
        nargs=2,
        help=(
            "Path to the 2 log files (with HW acceleration "
            "enabled/disabled) to parse."
        ),
    )
    parser.add_argument(
        "--json", action="store_true", help="Output parsed info as JSON."
    )
    args = parser.parse_args()
    gpu_averages = []
    for logfile in args.logfiles:
        gpu_avg = parse(logfile)
        gpu_averages.append(gpu_avg)
        if not args.json:
            filename = os.path.basename(logfile)
            print(
                "Processes in {} used {:.2f}% GPU.".format(filename, gpu_avg)
            )
    if args.json:
        output = {
            "date": datetime.utcnow().isoformat(),
            "hwacc_enabled": gpu_averages[0],
            "hwacc_disabled": gpu_averages[1],
        }
        print(json.dumps(output))
    else:
        if gpu_averages[0] > gpu_averages[1]:
            print()
            print("GPU usage is higher before compared to after.")
            print(
                (
                    "This seems correct, since more GPU is required for "
                    "processing when hardware acceleration is enabled."
                )
            )
        else:
            print()
            sys.exit(
                (
                    "Error: GPU usage is higher after (hardware acceleration "
                    "disabled) compared to before (hardware acceleration "
                    "enabled)."
                )
            )
