#!/usr/bin/env python3

import argparse
from datetime import datetime
import json
import os.path
import sys

from intel_gpu_top_parser import parse


if __name__ == "__main__":
    script = os.path.basename(__file__)
    parser = argparse.ArgumentParser(
        description=(
            "Parse json files generated by `intel_gpu_tool -J` before and "
            "after activating hardware acceleration to check if GPU is being "
            "used."
        ),
        epilog=(
            "Please ensure inputs are provided in the correct order: "
            "{} hw_acc_enabled.json hw_acc_disabled.json".format(script)
        ),
    )
    parser.add_argument(
        "logfiles",
        nargs=2,
        help=(
            "Path to the 2 log files (with HW acceleration "
            "enabled/disabled) to parse."
        ),
    )
    parser.add_argument(
        "--json", action="store_true", help="Output parsed info as JSON."
    )
    args = parser.parse_args()
    gpu_averages = []
    for logfile in args.logfiles:
        gpu_avg = parse(logfile)
        gpu_averages.append(gpu_avg)
        if not args.json:
            filename = os.path.basename(logfile)
            print(
                "Processes in {} used {:.2f}% GPU.".format(filename, gpu_avg)
            )
    if args.json:
        output = {
            "date": datetime.utcnow().isoformat(),
            "hwacc_enabled": gpu_averages[0],
            "hwacc_disabled": gpu_averages[1],
        }
        print(json.dumps(output))
    else:
        if gpu_averages[0] > gpu_averages[1]:
            print()
            print("GPU usage is higher before compared to after.")
            print(
                (
                    "This seems correct, since more GPU is required for "
                    "processing when hardware acceleration is enabled."
                )
            )
        else:
            print()
            sys.exit(
                (
                    "Error: GPU usage is higher after (hardware acceleration "
                    "disabled) compared to before (hardware acceleration "
                    "enabled)."
                )
            )
